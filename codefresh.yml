version: '1.0'
steps:
  setup_build_test_release:
    image: golang:1.10
    description: Setup env, unit test, build, acceptance test, release artifacts...
    working_directory: /go/src/github.com/kubernetes-helm
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/root/gcp-key.json
    commands:
      - echo $GCLOUD_SERVICE_KEY | base64 --decode --ignore-garbage > ~/gcp-key.json
      - mkdir -p ~/.docker
      - echo $DOCKERHUB_CONFIG | base64 --decode --ignore-garbage > ~/.docker/config.json
      - ln -s /codefresh/volume/${{CF_REPO_NAME}} chartmuseum && cd chartmuseum
      - make bootstrap testcloud goviz build acceptance
      - if [ ${{CF_BRANCH}} = master ]; then make release; fi
